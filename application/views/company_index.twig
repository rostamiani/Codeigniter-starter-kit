{% extends '_base.twig' %}

{% set page_header = 'لیست شرکت ها' %}
{% set page_header_icon = 'fa fa-cogs' %}

{% set top_buttons = 
	[
		{
			title: 'شرکت جدید',
			link: base_url()~"company/add",
			type: 'primary',
			icon: 'fas fa-plus-square'
		},
	]
%}

{% block content %}
<div class="card card-body shadow animated fadeInRight">
	<div class="row">
		<div class="col-lg-12">
			<div class="table-responsive">
				<table id="table_companies" class="table table-striped table-hover">
					<thead>
						<tr>
							<th class="text-center"><input type="checkbox" class="chk_select_all"></th>
							<th>شناسه</th>
							<th>عنوان شرکت</th>
							<th>وضعیت</th>
							<th>عملیات</th>	
						</tr>
					</thead>
					<tbody>
						{% for company in companies %}
						<tr>
							<td class="text-center"><input type="checkbox" class="chk_select"></td>
							<td class="field-id">{{company.id}}</td>
							<td class="field-title">{{company.title}}</td>
							<td class="field-status p-0">
								<select class="list_status form-control" data-company-id="{{company.id}}">
									{% for status in label.status %}
									<option value="{{loop.index0}}" {% if company.status == loop.index0 %}selected{% endif %}>
										{{status}}
									</option>
									{% endfor %}
								</select>
							</td>
							<td class="operations p-0">
								<a href="{{base_url()}}company/update/{{company.id}}" class="btn btn-primary btn-update"> ویرایش </a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	$(document).ready(function() {
		
		// Initialize datatable plugin
		table_companies = $('#table_companies').DataTable({
			// "processing": true,
			// "serverSide": true,
			// searchDelay: 1200,
			// 'ajax': '{{base_url()}}companys/ajax_datatable_list',
        	language: {
				url: "{{base_url()}}assets/js/plugins/dataTables/Persian.json"
			},
			ordering: false,
			paging: false,
			searching: false,
			lengthMenu: false
		});
		
		// Change status on list change
		$('#table_companies .list_status').change(function(){
			
			// Display loading animation
			$(this).addClass('loading bg-primary').prop('disabled',true);
			
			// Get status and company_id from list
			var company_id = $(this).data('company-id');
			var selected_status = $(this).find('option:selected').val();
			var this_select = this;
			
			// Send change request to server
			$.getJSON("{{base_url()}}company/ajax_set/"+company_id+"/status/"+selected_status)
			.done(function(data){
				// If success
				if(data.code == 0)
				{
					// Remove animation
					$(this_select).removeClass('loading bg-primary').prop('disabled',false);
				}
				else
				{
					// Remove animation
					$(this_select).removeClass('loading bg-primary').prop('disabled',false);
					
					// Show error message
					modal_message('خطا در ویرایش');
				}
			})
			// If connection failed
			.fail(function(){
				// Show error message
				modal_message('خطای ارتباط با سایت');
			})
        });
        
        // Select, deselect all chekboxes if the header checkbox changed
        $('.chk_select_all').change(function(){
            
            // Check all checkboxes 
            $('.chk_select').prop('checked', $(this).is(':checked') );
        });

        // Check header checkbox if all checkboxes was selected
        $('.chk_select').change(function(){

            // If all are cheched, check header checkbox
            $('.chk_select_all').prop('checked', $('.chk_select').length == $('.chk_select:checked').length);
        });
        
	}); // Document Ready
</script>

{# {{dump()}} #}
{% endblock %}