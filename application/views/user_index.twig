{% extends '_base.twig' %}

{% set page_header = 'لیست کاربران' %}
{% set page_header_icon = 'fa fa-users' %}

{% set top_buttons = 
	[
		{
			title: 'کاربر جدید',
			link: base_url()~"user/add",
			type: 'primary',
			icon: 'fas fa-plus-square'
		},
	]
%}

{% block top_buttons_custom %}
	ویرایش گروهی:
	<select class="list_status_all form-control">
		{% for status in label.status %}
		<option value="{{loop.index0}}">
			{{status}}
		</option>
		{% endfor %}
	</select>
{% endblock top_buttons_custom %}

{% block content %}
<div class="card card-body shadow animated fadeInRight">
	<div class="row">
		<div class="col-lg-12">
			<div class="table-responsive">
				<table id="table_users" class="table table-striped table-hover">
					<thead>
						<tr>
							<th class="text-center"><input type="checkbox" class="chk_select_all"></th>
							<th>شناسه</th>
							<th>نام کاربری</th>
							<th>نام</th>
							<th>نام خانوادگی</th>
							<th>نام شرکت</th>
							<th>وضعیت</th>
							<th>عملیات</th>	
						</tr>
					</thead>
					<tbody>
						{% for user in users %}
						<tr>
							<td class="text-center"><input type="checkbox" class="chk_select" data-user-id="{{user.id}}"></td>
							<td class="field-id">{{user.id}}</td>
							<td class="field-username">{{user.username}}</td>
							<td class="field-first_name">{{user.first_name}}</td>
							<td class="field-last_name">{{user.last_name}}</td>
							<td class="field-company_title">{{user.company_title}}</td>
							<!-- <td class="field-status">{{label.status[user.status]}}</td> -->
							<td class="field-status p-0">
								<select class="list_status form-control" data-user-id="{{user.id}}">
									{% for status in label.status %}
									<option value="{{loop.index0}}" {% if user.status == loop.index0 %}selected{% endif %}>
										{{status}}
									</option>
									{% endfor %}
								</select>
							</td>
							<td class="operations p-0">
								<a href="{{base_url()}}user/update/{{user.id}}" class="btn btn-primary btn-update"> ویرایش </a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	$(document).ready(function() {
		
		// Initialize datatable plugin
		table_users = $('#table_users').DataTable({
			// "processing": true,
			// "serverSide": true,
			// searchDelay: 1200,
			// 'ajax': '{{base_url()}}users/ajax_datatable_list',
        	language: {
				url: "{{base_url()}}assets/js/plugins/dataTables/Persian.json"
			},
		});
		
		// Change status on list change
		$('#table_users .list_status').change(function(){
			
			// Display loading animation
			$(this).addClass('loading bg-primary').prop('disabled',true);
			
			// Get status and user_id from list
			var user_id = $(this).data('user-id');
			var selected_status = $(this).find('option:selected').val();
			var this_select = this;
			
			// Send change request to server
			$.getJSON("{{base_url()}}user/ajax_set/"+user_id+"/status/"+selected_status)
			.done(function(data){
				// If success
				if(data.code == 0)
				{
					// Remove animation
					$(this_select).removeClass('loading bg-primary').prop('disabled',false);
				}
				else
				{
					// Remove animation
					$(this_select).removeClass('loading bg-primary').prop('disabled',false);
					
					// Show error message
					modal_message('خطا در ویرایش');
				}
			})
			// If connection failed
			.fail(function(){
				// Show error message
				modal_message('خطای ارتباط با سایت');
			})
		})
		
		// Deleting confirmation
		$('.btn-remove').click(function () {
			
			// Get hyperlink (href property is not used to prevent accedental deletes)
			var href = $(this).data('href');
			
			// Show confirmation modal
			username = $(this).closest('tr').find('td.field-username').text();
			modal_confirm('کاربر '+username+' حذف شود؟', function () {
				window.location = href;
			});
			
			// Prevent default behaviuor
			return false;
		})

		// Select, deselect all chekboxes if the header checkbox changed
		$('.chk_select_all').change(function(){
	
			// Check all checkboxes 
			$('.chk_select').prop('checked', $(this).is(':checked') );
		});

		// Check header checkbox if all checkboxes was selected
		$('.chk_select').change(function(){

			// If all are cheched, check header checkbox
			$('.chk_select_all').prop('checked', $('.chk_select').length == $('.chk_select:checked').length);
		});

	}); // Document Ready
</script>

{# {{dump()}} #}
{% endblock %}